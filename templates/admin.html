<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>
        {% if device_context %}
            {{ device_context.icon }} {{ device_context.name }} - Admin Panel
        {% else %}
            üê† Water System Admin Panel
        {% endif %}
    </title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        /* CSS Variables dla device context - ustawiane przez JavaScript */
        :root {
            --device-color: #3498db;
            --device-color-light: rgba(52, 152, 219, 0.2);
            --device-color-medium: rgba(52, 152, 219, 0.4);
            --device-color-dark: rgba(52, 152, 219, 0.8);
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        /* Device-specific body classes */
        body.device-context {
            background: linear-gradient(135deg, var(--device-color-light) 0%, var(--device-color-medium) 100%);
        }

        .container {
            width: 85%;
            /* max-width: 1400px; */
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, var(--device-color) 0%, var(--device-color-dark) 100%);
            color: white;
            padding: 20px 30px;
            position: relative;
        }

        .header h1 {
            font-size: 28px;
            margin-bottom: 5px;
        }

        .header .subtitle {
            opacity: 0.9;
            font-size: 14px;
        }

        .header-controls {
            position: absolute;
            top: 20px;
            right: 30px;
            display: flex;
            gap: 15px;
            align-items: center;
        }

        .dashboard-btn {
            background: rgba(255,255,255,0.2);
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s;
            text-decoration: none;
        }

        .dashboard-btn:hover {
            background: rgba(255,255,255,0.3);
            transform: translateY(-1px);
        }

        .session-info {
            background: rgba(255,255,255,0.1);
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 12px;
            backdrop-filter: blur(10px);
        }

        .logout-btn {
            background: #e74c3c;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s;
        }

        .logout-btn:hover {
            background: #c0392b;
            transform: translateY(-1px);
        }

        .content {
            padding: 30px;
        }

        .section {
            margin-bottom: 30px;
        }

        .section h2 {
            color: #2c3e50;
            margin-bottom: 15px;
            font-size: 20px;
            border-bottom: 2px solid var(--device-color);
            padding-bottom: 5px;
        }

        .quick-queries {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .quick-btn {
            background: linear-gradient(135deg, var(--device-color), var(--device-color-dark));
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s;
            font-size: 14px;
        }

        .quick-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px var(--device-color-medium);
        }

        .quick-btn:active {
            transform: translateY(0);
        }

        .sql-editor {
            margin-bottom: 20px;
        }

        .sql-textarea {
            width: 100%;
            padding: 15px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
            font-size: 14px;
            resize: vertical;
            background: #f8f9fa;
        }

        .sql-textarea:focus {
            outline: none;
            border-color: var(--device-color);
            background: white;
        }

        .execute-section {
            display: flex;
            gap: 10px;
            align-items: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .execute-btn {
            background: linear-gradient(135deg, #27ae60, #229954);
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            font-size: 16px;
            transition: all 0.3s;
        }

        .execute-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(39, 174, 96, 0.4);
        }

        .execute-btn:disabled {
            background: #95a5a6;
            cursor: not-allowed;
            transform: none;
        }

        .export-section {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .export-btn {
            background: linear-gradient(135deg, #e74c3c, #c0392b);
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 12px;
            text-decoration: none;
            display: inline-block;
            transition: all 0.3s;
        }

        .export-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 3px 10px rgba(231, 76, 60, 0.4);
        }

        .results-section {
            margin-top: 20px;
        }

        .results-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            flex-wrap: wrap;
            gap: 10px;
        }

        .results-info {
            color: #7f8c8d;
            font-size: 14px;
        }
/* 
        .results-table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            max-height: 1000px;
            overflow-y: auto;
            display: block;
            position: relative;
        }

        .results-table thead,
        .results-table tbody {
            display: table;
            width: 100%;
            table-layout: fixed;
        }

        .results-table thead {
            border-bottom: solid 10px white;
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .results-table th,
        .results-table td {
            padding: 8px 4px;
            text-align: center;
        
            border-right: 1px solid #ecf0f1;
            word-wrap: break-word;
            overflow-wrap: break-word;
            vertical-align: middle;
        }

        .results-table th {
            color: black;
            font-weight: bold;
            height: 180px;
            min-height: 80px;
            position: relative;
            white-space: nowrap;
        }

        .results-table th span {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) rotate(-90deg);
            transform-origin: center center;
            white-space: nowrap;
            font-size: 14px;
            font-weight: bold;
            letter-spacing: 0.5px;
        }

        .results-table.few-columns th {
            height: auto;
            min-height: 40px;
        }

        .results-table.few-columns th span {
            transform: translate(-50%, -50%) rotate(0deg);
            position: static;
            transform: none;
            display: block;
            padding: 10px;
            font-size: 13px;
        }

        .results-table td {
            font-size: 12px;
            max-width: 100px;
            padding: 4px 4px;
        } */

        /* Device-type specific column styling */
        .th-id, .th-device_id, .th-timestamp, .th-event_type, .th-received_at {
            background-color: #a6b5c5;
        }

        .th-pump_duration, .th-pump_attempts, .th-volume_ml, .th-time_gap_1, 
        .th-time_gap_2, .th-water_trigger_time, .th-daily_volume_ml {
            background-color: rgb(106, 191, 248);
        }

        .th-gap1_fail_sum, .th-gap2_fail_sum, .th-water_fail_sum {
            background-color: rgb(252, 107, 107);
        }

        .th-temperature, .th-humidity {
            background-color: #f39c12;
        }

        .th-zone_status, .th-motion_detected {
            background-color: #95a5a6;
        }

        .th-device_type {
            background-color: #9b59b6;
        }

        .th-water_status{
            background-color: #a6b5c5;
        }

        .th-system_status{
            background-color: #a0c9f5;
        }

        .row-auto-pump {
            background-color: #e3f2fd; 
        }

        .row-manual-normal {
            background-color: #e8f5e8; 
        }

        .row-manual-extended {
            background-color: #cdf1ff;
        }

        .row-auto-complete {
            background-color: #fafafa;
        }

        .row-stats-reset {
            background-color: #f3f2c5;
        }

        .row-default {
            background-color: white;
        }

        .system-status-error{
            /* border-bottom: 2px solid #af4a55;
            border-top: 2px solid #af4a55; */
            background-color: rgb(252, 107, 107);

        }


        /* ############################################################################################################################ */


        /* ============================================
        TRANSPONOWANA TABELA - Horizontal Layout
        ============================================ */

        .table-transposed-container {
            width: 100%;
            overflow-x: auto;
            overflow-y: visible;
            border: 1px solid #ddd;
            border-radius: 8px;
            background: white;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .results-table-transposed {
            border-collapse: separate;
            border-spacing: 0;
            width: auto;
            min-width: 100%;
            background: white;
        }

        /* Nag≈Ç√≥wki rekord√≥w (u g√≥ry) */
        .results-table-transposed thead {
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .results-table-transposed thead th {
            background: linear-gradient(135deg, var(--device-color, #667eea) 0%, var(--device-color-dark, #764ba2) 100%);
            color: white;
            padding: 12px 20px;
            text-align: center;
            font-size: 13px;
            font-weight: 600;
            border-right: 1px solid rgba(255,255,255,0.2);
            border-bottom: 2px solid white;
            white-space: nowrap;
            min-width: 120px;
            vertical-align: middle;
        }

        /* Pierwsza kolumna nag≈Ç√≥wka (sticky) */
        .field-header.sticky-col {
            position: sticky;
            left: 0;
            z-index: 20;
            background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%) !important;
            /* min-width: 180px !important;/ */
            max-width: 180px;
            border-right: 3px solid #1a252f !important;
            font-weight: bold;
        }

        /* Numer rekordu w nag≈Ç√≥wku */
        .record-number {
            font-size: 14px;
            font-weight: bold;
        }

        /* Nazwy p√≥l (lewa kolumna - sticky) */
        .field-name.sticky-col {
            position: sticky;
            left: 0;
            z-index: 15;
            font-weight: 600;
            color: #2c3e50;
            padding: 10px 12px;
            text-align: left;
            border-right: 3px solid #ddd;
            border-bottom: 1px solid #e0e0e0;
            white-space: nowrap;
            min-width: 160px;
            max-width: 180px;
            font-size: 13px;
            background: #f8f9fa;
        }

        /* Kom√≥rki z danymi */
        .data-cell {
            padding: 10px 15px;
            border-right: 1px solid #e8e8e8;
            border-bottom: 1px solid #e8e8e8;
            text-align: center;
            white-space: nowrap;
            min-width: 120px;
            font-size: 12px;
            background: white;
        }

        /* Kategorie kolor√≥w dla p√≥l */
        .cat-general { background: #ecf0f1 !important; }
        .cat-sensor { background: #d5e8f7 !important; }
        .cat-errors { background: #fadbd8 !important; }
        .cat-temp { background: #fdebd0 !important; }
        .cat-security { background: #e8daef !important; }
        .cat-status { background: #d4e9e2 !important; }
        .cat-default { background: #f8f9fa !important; }

        /* Kolory dla nag≈Ç√≥wk√≥w rekord√≥w (event types) */
        .record-header.row-auto-pump { 
            background: linear-gradient(135deg, #5dade2 0%, #3498db 100%) !important; 
        }
        .record-header.row-manual-normal { 
            background: linear-gradient(135deg, #58d68d 0%, #27ae60 100%) !important; 
        }
        .record-header.row-manual-extended { 
            background: linear-gradient(135deg, #5dade2 0%, #3498db 100%) !important; 
        }
        .record-header.row-auto-complete { 
            background: linear-gradient(135deg, #85929e 0%, #5d6d7e 100%) !important; 
        }
        .record-header.row-stats-reset { 
            background: linear-gradient(135deg, #f4d03f 0%, #f39c12 100%) !important; 
        }
        .record-header.system-status-error { 
            background: linear-gradient(135deg, #ec7063 0%, #e74c3c 100%) !important; 
        }

        /* Hover efekty */
        .results-table-transposed tbody tr:hover .field-name {
            background: #e3f2fd !important;
            font-weight: bold;
        }

        .results-table-transposed tbody tr:hover .data-cell {
            background: #f0f8ff !important;
        }

        /* Null values */
        .null-value {
            color: #bdc3c7;
            font-style: italic;
            font-size: 11px;
        }

        /* Scrollbar styling */
        .table-transposed-container::-webkit-scrollbar {
            height: 12px;
        }

        .table-transposed-container::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 6px;
        }

        .table-transposed-container::-webkit-scrollbar-thumb {
            background: linear-gradient(135deg, var(--device-color, #667eea) 0%, var(--device-color-dark, #764ba2) 100%);
            border-radius: 6px;
        }

        .table-transposed-container::-webkit-scrollbar-thumb:hover {
            background: var(--device-color-dark, #764ba2);
        }



        @media (max-width: 768px) {
            .content {
                padding: 20px;
            }

            .container{
                width: 95%;
            }

            .header-controls {
                position: static;
                margin-top: 15px;
                justify-content: flex-start;
            }

            .quick-queries {
                grid-template-columns: 1fr;
            }

            .execute-section {
                flex-direction: column;
                align-items: stretch;
            }

            .execute-btn,
            .export-btn {
                width: 100%;
                margin: 5px 0;
            }

            .results-table {
                font-size: 12px;
            }

            .results-table th,
            .results-table td {
                padding: 8px 4px;
            }
        }

        .alert {
            padding: 15px;
            margin: 15px 0;
            border-radius: 8px;
            font-weight: bold;
        }

        .alert.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .alert.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .alert.info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }

        .alert.warning {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }

        .loading {
            text-align: center;
            padding: 20px;
            color: #7f8c8d;
        }

        .loading::after {
            content: '';
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid var(--device-color);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-left: 10px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .no-results {
            text-align: center;
            padding: 40px;
            color: #7f8c8d;
            font-style: italic;
        }

        .session-warning {
            position: fixed;
            top: 20px;
            right: 20px;
            background: #f39c12;
            color: white;
            padding: 15px 20px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
            display: none;
            z-index: 1000;
        }

        .help-section {
            background: #ecf0f1;
            padding: 20px;
            border-radius: 8px;
            margin-top: 20px;
        }

        .help-section h3 {
            color: #2c3e50;
            margin-bottom: 10px;
        }

        .help-section code {
            background: #34495e;
            color: white;
            padding: 2px 6px;
            border-radius: 4px;
            font-family: monospace;
        }

        .help-section ul {
            margin-left: 20px;
        }

        .help-section li {
            margin: 5px 0;
        }
</style>
</head>
<body {% if device_context %}class="device-type-{{ device_context.type }}"{% endif %}>
    <div class="session-warning" id="sessionWarning">
        ‚ö†Ô∏è Session expires in <span id="warningTime">5</span> minutes. Click to extend.
    </div>

    <div class="container">
        <div class="header">
            <h1>
                {% if device_context %}
                    {{ device_context.icon }} {{ device_context.name }} - Admin Panel
                {% else %}
                    üê† Dolewka Database - Admin Panel
                {% endif %}
            </h1>
            <div class="subtitle">
                {% if device_context %}
                    {{ device_context.description }} - Device Management Interface
                {% else %}
                    Multi-device IoT management interface
                {% endif %}
            </div>
            <div class="header-controls">
                <a href="/dashboard" class="dashboard-btn">
                    üè† Dashboard
                </a>
                <div class="session-info" id="sessionInfo">
                    Loading session info...
                </div>
                <button class="logout-btn" onclick="logout()">
                    Logout
                </button>
            </div>
        </div>

        <div class="content">
            <!-- Quick Queries Section -->
            <div class="section">
                <h2>üìä Quick Queries
                    {% if device_context %}
                        - {{ device_context.name }}
                    {% endif %}
                </h2>
         
                <div class="quick-queries" id="quickQueriesContainer">
                    <!-- Quick queries will be loaded dynamically -->
                </div>
            </div>

            <!-- Results Section -->
            <div class="section">
                <div class="results-header">
                    <h2>üìã Query Results</h2>
                    <div class="results-info" id="resultsInfo">Ready for query</div>
                </div>
                
                <div id="resultsContainer">
                    <div class="no-results">Enter a SQL query and click Execute to see results</div>
                </div>
            </div>

            <!-- Custom SQL Query Section -->
            <div class="section">
                <h2>üíª Custom SQL Query</h2>
                <div class="sql-editor">
                    <textarea 
                        id="sqlQuery" 
                        class="sql-textarea" 
                        placeholder="SELECT * FROM water_events WHERE device_type = '{{ device_context.type if device_context else 'water_system' }}' ORDER BY received_at DESC LIMIT 50;"
                    ></textarea>
                </div>
                
                <div class="execute-section">
                    <button class="execute-btn" onclick="executeCustomQuery()" id="executeBtn">
                        Execute Query
                    </button>
                    
                    <div class="export-section" id="exportSection" style="display: none;">
                        <span>Export:</span>
                        <a href="#" class="export-btn" id="exportCsv">CSV</a>
                        <a href="#" class="export-btn" id="exportJson">JSON</a>
                    </div>
                </div>
            </div>
            
            <!-- Help Section -->
            <div class="help-section">
                <h3>üìö Help & Examples
                    {% if device_context %}
                        - {{ device_context.name }}
                    {% endif %}
                </h3>
                <p><strong>Available table:</strong> <code>water_events</code></p>
                {% if device_context %}
                <p><strong>Relevant columns for {{ device_context.name }}:</strong> 
                    {% for column in device_context.columns %}
                        <code>{{ column }}</code>{% if not loop.last %}, {% endif %}
                    {% endfor %}
                </p>
                <p><strong>Event types:</strong> 
                    {% for event_type in device_context.event_types %}
                        <code>{{ event_type }}</code>{% if not loop.last %}, {% endif %}
                    {% endfor %}
                </p>
                {% else %}
                <p><strong>Columns:</strong> id, device_id, device_type, timestamp, unix_time, event_type, volume_ml, water_status, system_status, received_at, client_ip, temperature, humidity, zone_status, motion_detected</p>
                {% endif %}
                <p><strong>Example queries:</strong></p>
                <ul>
                    {% if device_context and device_context.type == 'water_system' %}
                    <li><code>SELECT * FROM water_events WHERE device_type = 'water_system' AND event_type = 'AUTO_CYCLE_COMPLETE' LIMIT 10;</code> - Auto pump cycles</li>
                    <li><code>SELECT DATE(received_at), SUM(volume_ml) FROM water_events WHERE device_type = 'water_system' GROUP BY DATE(received_at);</code> - Daily volume</li>
                    <li><code>SELECT * FROM water_events WHERE device_type = 'water_system' AND pump_attempts > 1;</code> - Multiple pump attempts</li>
                    {% elif device_context and device_context.type == 'temperature_sensor' %}
                    <li><code>SELECT * FROM water_events WHERE device_type = 'temperature_sensor' AND temperature IS NOT NULL LIMIT 10;</code> - Temperature readings</li>
                    <li><code>SELECT AVG(temperature), AVG(humidity) FROM water_events WHERE device_type = 'temperature_sensor' AND DATE(received_at) = DATE('now');</code> - Today's averages</li>
                    {% elif device_context and device_context.type == 'security_system' %}
                    <li><code>SELECT * FROM water_events WHERE device_type = 'security_system' AND motion_detected = 1 LIMIT 10;</code> - Motion events</li>
                    <li><code>SELECT zone_status, COUNT(*) FROM water_events WHERE device_type = 'security_system' GROUP BY zone_status;</code> - Zone status summary</li>
                    {% else %}
                    <li><code>SELECT COUNT(*) FROM water_events;</code> - Total events count</li>
                    <li><code>SELECT device_type, COUNT(*) FROM water_events GROUP BY device_type;</code> - Events by device type</li>
                    <li><code>SELECT * FROM water_events WHERE system_status != 'OK';</code> - System issues</li>
                    {% endif %}
                </ul>
                <p><strong>Restrictions:</strong></p>
                <ul>
                    <li>Only SELECT queries allowed</li>
                    <li>Maximum 1000 results</li>
                    <li>10 second query timeout</li>
                    <li>Only water_events table accessible</li>
                </ul>
            </div>
        </div>
    </div>

    <script>

        // {% if device_context %}
        document.documentElement.style.setProperty('--device-color', '{{ device_context.color }}');
        document.documentElement.style.setProperty('--device-color-light', '{{ device_context.color }}22');
        document.documentElement.style.setProperty('--device-color-medium', '{{ device_context.color }}66');
        document.documentElement.style.setProperty('--device-color-dark', '{{ device_context.color }}CC');
        document.body.classList.add('device-context');
        // {% endif %}

        let currentQueryType = '';
        let currentDeviceType = '{{ device_context.type if device_context else "" }}';
        let sessionTimer = null;
        let warningShown = false;

        // Device-specific column translation
        function translateColumnName(columnName) {
            const baseTranslations = {
                'id': 'Event No.',
                'device_id': 'Device',
                'device_type': 'Device Type',
                'timestamp': 'Event Time(UTC)',
                'unix_time': 'Unix Time',
                'event_type': 'Event Type',
                'water_status': 'Water Status',
                'system_status': 'System Status',
                'received_at': 'Event Time',
                'client_ip': 'Client IP'
            };

            const deviceSpecificTranslations = {
                'water_system': {
                    'volume_ml': 'Water Volume (ml)',
                    'time_gap_1': 'Trigger Sensor(ON)',
                    'time_gap_2': 'Trigger Sensor(OFF)',
                    'water_trigger_time': 'Refill Response(s)',
                    'pump_duration': 'Pump Run Time(s)',
                    'pump_attempts': 'Pump Attempts',
                    'gap1_fail_sum': 'Sensor(ON) Errors',
                    'gap2_fail_sum': 'Sensor(OFF) Errors', 
                    'water_fail_sum': 'Refill Errors',
                    'last_reset_timestamp': 'Last Reset',
                    'algorithm_data': 'Event Log',
                    'daily_volume_ml': 'Water Added(ml)',
                },
                'temperature_sensor': {
                    'temperature': 'Temperature (¬∞C)',
                    'humidity': 'Humidity (%)',
                },
                'security_system': {
                    'zone_status': 'Zone Status',
                    'motion_detected': 'Motion Detected'
                }
            };
            
            // Check device-specific translations first
            if (currentDeviceType && deviceSpecificTranslations[currentDeviceType] && deviceSpecificTranslations[currentDeviceType][columnName]) {
                return deviceSpecificTranslations[currentDeviceType][columnName];
            }
            
            // Fall back to base translations
            return baseTranslations[columnName] || columnName;
        }

        // Load available queries for device type
        // function loadDeviceQueries() {
        //     if (!currentDeviceType) {
        //         loadLegacyQueries();
        //         return;
        //     }
        //     loadLegacyQueries();

            // fetch(`/api/available-queries/${currentDeviceType}`)
            //     .then(response => response.json())
            //     .then(data => {
            //         if (data.success) {
            //             const container = document.getElementById('quickQueriesContainer');
            //             container.innerHTML = '';
                        
            //             Object.entries(data.queries).forEach(([queryId, queryInfo]) => {
            //                 const btn = document.createElement('button');
            //                 btn.className = 'quick-btn';
            //                 btn.textContent = queryInfo.name;
            //                 btn.title = queryInfo.description;
            //                 btn.onclick = () => executeDeviceQuery(queryId);
            //                 container.appendChild(btn);
            //             });
            //         } else {
            //             console.error('Failed to load device queries:', data.error);
            //             loadLegacyQueries();
            //         }
            //     })
            //     .catch(error => {
            //         console.error('Error loading device queries:', error);
            //         loadLegacyQueries();
            //     });
        // }

        // ===== TIMEZONE CONVERSION UTILITIES =====
        /**
         * Convert unix timestamp to local Polish time
         * @param {number} unixTime - Unix timestamp (seconds)
         * @param {boolean} includeSeconds - Include seconds in output
         * @returns {string} Formatted local time
         */
        function formatLocalTime(unixTime, includeSeconds = true) {
            if (!unixTime || unixTime === 0) return 'N/A';

            const date = new Date(unixTime * 1000); // Convert to milliseconds

            const options = {
                timeZone: 'Europe/Warsaw',
                year: 'numeric',
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit',
                hour12: false
            };

            if (includeSeconds) {
                options.second = '2-digit';
            }

            return date.toLocaleString('pl-PL', options);
        }

        /**
         * Format timestamp column for display
         * Shows local time with UTC tooltip
         */
        function formatTimestampCell(unixTime) {
            if (!unixTime || unixTime === 0) return 'N/A';

            const localTime = formatLocalTime(unixTime, true);
            const utcTime = new Date(unixTime * 1000).toISOString();

            return `
                <span title="UTC: ${utcTime}" style="cursor: help; border-bottom: 1px dotted #666;">
                    ${localTime} CET
                </span>
            `;
        }

        /**
         * Format received_at (already in UTC string format)
         */
        function formatReceivedAt(receivedAtString) {
            if (!receivedAtString) return 'N/A';

            const date = new Date(receivedAtString);

            return date.toLocaleString('pl-PL', {
                timeZone: 'Europe/Warsaw',
                year: 'numeric',
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit',
                hour12: false
            }) + ' CET';
        }

        function loadDeviceQueries() {
            const container = document.getElementById('quickQueriesContainer');
            container.innerHTML = `
                <button class="quick-btn" onclick="executeQuickQuery('last24h')">Last 24 Hours</button>
                <button class="quick-btn" onclick="executeQuickQuery('last_100_events')">Last 100 Events</button>
                <button class="quick-btn" onclick="executeQuickQuery('all_events')">All Events</button>
                <button class="quick-btn" onclick="executeQuickQuery('errors')">Errors</button>
                <button class="quick-btn" onclick="executeQuickQuery('today_stats')">Today's Stats</button>
            `;
        }

        function executeDeviceQuery(queryType) {
            currentQueryType = queryType;
            const container = document.getElementById('resultsContainer');
            container.innerHTML = '<div class="loading">Executing query...</div>';
            
            const url = currentDeviceType 
                ? `/api/admin-device-query/${currentDeviceType}/${queryType}`
                : `/api/admin-quick-query/${queryType}`;
            
            fetch(url)
                .then(response => {
                    if (response.status === 401) {
                        alert('Session expired. Please login again.');
                        window.location.href = '/login';
                        return;
                    }
                    return response.json();
                })
                .then(data => {
                    if (data && data.success) {
                        displayResults(data.data);
                        updateResultsInfo(data.count);
                    } else if (data) {
                        showAlert(`Error: ${data.error}`, 'error');
                    }
                })
                .catch(error => {
                    showAlert(`Network error: ${error.message}`, 'error');
                });
        }
  
        // Mapowanie warto≈õci na polskie
        function translateCellValue(columnName, value) {

            if (columnName === 'timestamp' && value) {
                return value.replace(/\s*\([^)]*\)\s*$/, '');
            }

            const valueTranslations = {
                'event_type': {
                    'AUTO_PUMP': 'AUTO PUMP',
                    'MANUAL_NORMAL': 'MANUAL PUMP',
                    'MANUAL_EXTENDED': 'PUMP CALIBRATION',
                    'AUTO_CYCLE_COMPLETE': 'AUTO PUMP',
                    'STATISTICS_RESET': 'STATISTICS RESET',
                    'TEMP_READING': 'TEMP READING',
                    'HUMIDITY_READING': 'HUMIDITY READING',
                    'SENSOR_ERROR': 'SENSOR ERROR',
                    'DOOR_OPEN': 'DOOR OPEN',
                    'DOOR_CLOSE': 'DOOR CLOSE',
                    'MOTION_DETECTED': 'MOTION DETECTED',
                    'SYSTEM_ARM': 'SYSTEM ARM',
                    'SYSTEM_DISARM': 'SYSTEM DISARM'
                },
                'water_status': {
                    'OK': 'OK',
                    'NORMAL': 'NORMAL',
                    'LOW': 'LOW  ',
                    'BOTH_LOW': 'BOTH LOW',
                    'SENSOR1_LOW': 'SENSOR 1 LOW',
                    'SENSOR2_LOW': 'SENSOR 2 LOW',
                    'PARTIAL': 'PARTIAL',
                    'CHECKING': 'CHECKING'
                },
                'system_status': {
                    'OK': 'SYSTEM OK',
                    'ERROR': 'ERROR'
                },
                'zone_status': {
                    'ARMED': 'ARMED',
                    'DISARMED': 'DISARMED',
                    'OPEN': 'OPEN',
                    'CLOSED': 'CLOSED',
                    'TRIGGERED': 'TRIGGERED'
                },
                'motion_detected': {
                    '1': 'YES',
                    '0': 'NO',
                    'true': 'YES',
                    'false': 'NO'
                }
            };
            
            if (valueTranslations[columnName] && valueTranslations[columnName][value]) {
                return valueTranslations[columnName][value];
            }
            return value;
        }

        // Load session info on page load
        function loadSessionInfo() {
            fetch('/api/session-info')
                .then(response => response.json())
                .then(data => {
                    const sessionInfo = document.getElementById('sessionInfo');
                    const loginTime = new Date(data.login_time).toLocaleTimeString();
                    sessionInfo.innerHTML = `
                        üïí ${loginTime}<br>
                        <small>IP: ${data.client_ip}</small>
                    `;
                    
                    // Start session timer
                    startSessionTimer(data.timeout_minutes);
                })
                .catch(error => {
                    console.error('Failed to load session info:', error);
                });
        }

        function startSessionTimer(timeoutMinutes) {
            const totalMs = timeoutMinutes * 60 * 1000;
            const warningMs = 5 * 60 * 1000; // 5 minutes warning
            
            setTimeout(() => {
                showSessionWarning();
            }, totalMs - warningMs);
        }

        function showSessionWarning() {
            if (warningShown) return;
            warningShown = true;
            
            const warning = document.getElementById('sessionWarning');
            warning.style.display = 'block';
            
            let timeLeft = 5 * 60; // 5 minutes in seconds
            const warningTimeSpan = document.getElementById('warningTime');
            
            const countdown = setInterval(() => {
                const minutes = Math.floor(timeLeft / 60);
                const seconds = timeLeft % 60;
                warningTimeSpan.textContent = `${minutes}:${seconds.toString().padStart(2, '0')}`;
                timeLeft--;
                
                if (timeLeft < 0) {
                    clearInterval(countdown);
                    alert('Session expired. You will be redirected to login page.');
                    window.location.href = '/login';
                }
            }, 1000);
            
            // Click warning to extend session (make any API call)
            warning.onclick = () => {
                fetch('/api/session-info')
                    .then(() => {
                        warning.style.display = 'none';
                        warningShown = false;
                        clearInterval(countdown);
                        showAlert('Session extended successfully', 'success');
                    });
            };
        }

        function showAlert(message, type) {
            const resultsContainer = document.getElementById('resultsContainer');
            const alert = document.createElement('div');
            alert.className = 'alert ' + type;
            alert.textContent = message;
            
            // Insert at top of results container
            resultsContainer.insertBefore(alert, resultsContainer.firstChild);
            
            setTimeout(() => {
                if (resultsContainer.contains(alert)) {
                    resultsContainer.removeChild(alert);
                }
            }, 5000);
        }

        function updateResultsInfo(count, limited = false) {
            const info = document.getElementById('resultsInfo');
            let text = `${count} rows returned`;
            if (limited) {
                text += ' (limited to 1000)';
            }
            info.textContent = text;
        }

        function displayResults(data) {
            const container = document.getElementById('resultsContainer');

            if (!data || data.length === 0) {
                container.innerHTML = '<div class="no-results">No results found</div>';
                updateResultsInfo(0);
                document.getElementById('exportSection').style.display = 'none';
                return;
            }

            const preferredColumnOrder = [
                'id','device_id', 'device_type', 'timestamp', 'event_type',
                'pump_duration', 'volume_ml', 'pump_attempts',
                'time_gap_1', 'gap1_fail_sum', 'time_gap_2', 'gap2_fail_sum'
                , 'water_trigger_time', 'water_fail_sum',
                  'daily_volume_ml', 'temperature', 'humidity', 'zone_status', 'motion_detected', 'system_status',
                 'client_ip', 'water_status', 'received_at', 'last_reset_timestamp',
                , 'unix_time', 'algorithm_data', 
            ];


            const availableColumns = Object.keys(data[0]);
            const orderedColumns = preferredColumnOrder
                .filter(col => availableColumns.includes(col))
                .concat(availableColumns.filter(col => !preferredColumnOrder.includes(col)));

            // 2. Odwr√≥ƒá kolejno≈õƒá - najnowsze po lewej (zaraz przy sticky column)
            const orderedData = [...data];

            // 3. Mapowanie kategorii kolor√≥w
            const columnCategories = {
                'id': 'cat-general',
                'device_id': 'cat-general',
                'device_type': 'cat-general',
                'timestamp': 'cat-general',
                'event_type': 'cat-general',
                'received_at': 'cat-general',
                'pump_duration': 'cat-sensor',
                'pump_attempts': 'cat-sensor',
                'volume_ml': 'cat-sensor',
                'time_gap_1': 'cat-sensor',
                'time_gap_2': 'cat-sensor',
                'water_trigger_time': 'cat-sensor',
                'gap1_fail_sum': 'cat-errors',
                'gap2_fail_sum': 'cat-errors',
                'water_fail_sum': 'cat-errors',
                'temperature': 'cat-temp',
                'humidity': 'cat-temp',
                'zone_status': 'cat-security',
                'motion_detected': 'cat-security',
                'water_status': 'cat-status',
                'system_status': 'cat-status'
            };

            // 4. Buduj HTML tabeli (transponowanej)
            let html = '<div class="table-transposed-container">';
            html += '<table class="results-table-transposed">';
            
            // THEAD: Nag≈Ç√≥wki kolumn = numery rekord√≥w
            html += '<thead><tr>';
            html += '<th class="field-header sticky-col">Field Name</th>';
            orderedData.forEach((row, index) => {
                const recordNumber = data.length - index; // Najnowsze majƒÖ najwiƒôkszy numer
                const eventType = row['event_type'] || '';
                const systemStatus = row['system_status'] || '';

                // Klasy dla nag≈Ç√≥wka rekordu
                let headerClass = 'record-header';
                if (eventType) {
                    const eventClass = getEventTypeRowClass(eventType);
                    headerClass += ' ' + eventClass;
                }
                if (systemStatus === 'ERROR') {
                    headerClass += ' system-status-error';
                }

                html += `<th class="${headerClass}" title="Record #${recordNumber}">
                            <div class="record-number">#${recordNumber}</div>
                         </th>`;
            });
            html += '</tr></thead>';

            // TBODY: Ka≈ºdy wiersz = jedno pole
            html += '<tbody>';
            orderedColumns.forEach(fieldName => {
                const categoryClass = columnCategories[fieldName] || 'cat-default';

                html += '<tr>';
                // Pierwsza kolumna: nazwa pola (sticky)
                html += `<td class="field-name sticky-col ${categoryClass}" title="${fieldName}">
                            ${translateColumnName(fieldName)}
                         </td>`;
                     
                // Kolejne kolumny: warto≈õci z ka≈ºdego rekordu
                orderedData.forEach(record => {
                    const value = record[fieldName];
                    const translatedValue = translateCellValue(fieldName, value);
                    const displayValue = (translatedValue !== null && translatedValue !== undefined) 
                        ? translatedValue 
                        : '<span class="null-value">‚Äî</span>';

                    html += `<td class="data-cell">${displayValue}</td>`;
                });

                html += '</tr>';
            });
            html += '</tbody>';

            html += '</table>';
            html += '</div>';

            container.innerHTML = html;

            // Show export options
            document.getElementById('exportSection').style.display = 'flex';
            setupExportLinks();

            enableHorizontalScrollOnWheel();

            console.log(`‚úÖ Transposed table: ${orderedColumns.length} fields √ó ${orderedData.length} records`);
        }   

        function getEventTypeRowClass(eventType) {
            const eventTypeClasses = {
                'AUTO_PUMP': 'row-auto-pump',
                'MANUAL_NORMAL': 'row-manual-normal', 
                'MANUAL_EXTENDED': 'row-manual-extended',
                'AUTO_CYCLE_COMPLETE': 'row-auto-complete',
                'STATISTICS_RESET': 'row-stats-reset',
                'TEMP_READING': 'row-default',
                'HUMIDITY_READING': 'row-default',
                'SENSOR_ERROR': 'row-manual-extended',
                'DOOR_OPEN': 'row-default',
                'DOOR_CLOSE': 'row-default',
                'MOTION_DETECTED': 'row-manual-extended',
                'SYSTEM_ARM': 'row-default',
                'SYSTEM_DISARM': 'row-default'
            };
            return eventTypeClasses[eventType] || 'row-default';
        }

        function setupExportLinks() {
            const csvLink = document.getElementById('exportCsv');
            const jsonLink = document.getElementById('exportJson');
            csvLink.onclick = () => exportData('csv');
            jsonLink.onclick = () => exportData('json');
        }

        function exportData(format) {
            if (!currentQueryType) {
                showAlert('No query to export', 'error');
                return;
            }
        
            const url = currentDeviceType 
                ? `/api/quick-export/${currentDeviceType}/${currentQueryType}/${format}`
                : `/api/quick-export/${currentQueryType}/${format}`;
                
            window.open(url, '_blank');
        }       

        function executeQuery(query, isQuick = false) {
            if (!query.trim()) {
                showAlert('Please enter a SQL query', 'error');
                return;
            }

            const container = document.getElementById('resultsContainer');
            container.innerHTML = '<div class="loading">Executing query...</div>';
            const executeBtn = document.getElementById('executeBtn');
            executeBtn.disabled = true;
            executeBtn.textContent = 'Executing...';
            const endpoint = isQuick ? `/api/admin-quick-query/${query}` : '/api/admin-query';
            const requestData = isQuick ? null : { query: query };

            fetch(endpoint, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: requestData ? JSON.stringify(requestData) : null
            })
            .then(response => {
                if (response.status === 401) {
                    // Session expired
                    alert('Session expired. Please login again.');
                    window.location.href = '/login';
                    return;
                }
                return response.json();
            })
            .then(data => {
                if (data && data.success) {
                    displayResults(data.data);
                    updateResultsInfo(data.count, data.limited);
                    
                    if (data.limited) {
                        showAlert('Results limited to 1000 rows. Use LIMIT clause for specific ranges.', 'info');
                    }

                } else if (data) {
                    showAlert(`Error: ${data.error}`, 'error');
                    document.getElementById('exportSection').style.display = 'none';
                }
            })
            .catch(error => {
                showAlert(`Network error: ${error.message}`, 'error');
                document.getElementById('exportSection').style.display = 'none';
            })
            .finally(() => {
                executeBtn.disabled = false;
                executeBtn.textContent = 'Execute Query';
            });
        }

        function executeCustomQuery() {
            const query = document.getElementById('sqlQuery').value;
            executeQuery(query, false);
        }

        function executeQuickQuery(type) {
            executeDeviceQuery(type);
        }

        // #####################################################################################################################

        function logout() {
            if (confirm('Are you sure you want to logout?')) {
                fetch('/logout', { method: 'POST' })
                    .then(() => {
                        window.location.href = '/login';
                    })
                    .catch(() => {
                        // Even if request fails, redirect to login
                        window.location.href = '/login';
                    });
            }
        }

        // Load default query on page load
        document.addEventListener('DOMContentLoaded', function() {
            
            const defaultQuery = currentDeviceType 
                ? `SELECT * FROM water_events WHERE device_type = '${currentDeviceType}' ORDER BY received_at DESC LIMIT 20;`
                : 'SELECT * FROM water_events ORDER BY received_at DESC LIMIT 20;';
            
            document.getElementById('sqlQuery').value = defaultQuery;
            loadSessionInfo();
            loadDeviceQueries();
        });

        // Execute query on Ctrl+Enter
        document.getElementById('sqlQuery').addEventListener('keydown', function(e) {
            if (e.ctrlKey && e.key === 'Enter') {
                executeCustomQuery();
            }
        });

        // Heartbeat to keep session alive during active use
        setInterval(() => {
            if (!warningShown) {
                fetch('/api/session-info')
                    .catch(() => {
                        console.log('Session check failed');
                    });
            }
        }, 5 * 60 * 1000); // Every 5 minutes


  

            // ============================================
        // HORIZONTAL SCROLL Z AKUMULACJƒÑ - Smooth UX
        // ============================================

        let scrollTimeout = null;
        let accumulatedScroll = 0; // Bufor dla krƒôce≈Ñ
        let isScrolling = false;

        // Funkcja dodajƒÖca horizontal scroll do tabeli
        function enableHorizontalScrollOnWheel() {
            const containers = document.querySelectorAll('.table-transposed-container');

            containers.forEach(container => {
                // Usu≈Ñ stary listener je≈õli istnieje
                container.removeEventListener('wheel', handleAccumulatedScroll);

                // Dodaj nowy listener
                container.addEventListener('wheel', handleAccumulatedScroll, { passive: false });
            });

            console.log('‚úÖ Horizontal scroll with accumulation enabled');
        }

        // Handler dla wheel event z akumulacjƒÖ
        function handleAccumulatedScroll(e) {
            const container = e.currentTarget;

            // Sprawd≈∫ czy tabela ma horizontal scroll
            const hasHorizontalScroll = container.scrollWidth > container.clientWidth;

            if (!hasHorizontalScroll) {
                return; // Brak horizontal scroll, pozw√≥l na normalny scroll strony
            }

            // Zapobiegaj domy≈õlnemu pionowemu scrollowi
            e.preventDefault();

            // Dynamicznie oblicz szeroko≈õƒá kolumny
            const firstDataCell = container.querySelector('.data-cell');
            let columnWidth = 120; // fallback

            if (firstDataCell) {
                const computedStyle = window.getComputedStyle(firstDataCell);
                columnWidth = firstDataCell.offsetWidth + 
                             parseInt(computedStyle.marginLeft) + 
                             parseInt(computedStyle.marginRight);
            }

            // Okre≈õl kierunek scrollowania
            const direction = e.deltaY > 0 ? 1 : -1;

            // AKUMULUJ przesuniƒôcie (zbieraj wszystkie krƒôcenia)
            accumulatedScroll += columnWidth * direction;

            // Anuluj poprzedni timeout
            clearTimeout(scrollTimeout);

            // Ustaw nowy timeout - wykonaj scroll po zako≈Ñczeniu serii krƒôce≈Ñ
            scrollTimeout = setTimeout(() => {
                executeAccumulatedScroll(container, columnWidth);
            }, 100); // 100ms debounce - jak d≈Çugo czeka po ostatnim krƒôceniu
        }

        // Wykonaj zsumowany scroll z animacjƒÖ
        function executeAccumulatedScroll(container, columnWidth) {
            if (accumulatedScroll === 0) {
                return; // Nic do scrollowania
            }

            // Wykonaj JEDEN p≈Çynny scroll o ca≈ÇƒÖ zsumowanƒÖ warto≈õƒá
            const targetScroll = container.scrollLeft + accumulatedScroll;

            container.scrollTo({ 
                left: targetScroll, 
                behavior: 'smooth' 
            });

            // Resetuj akumulator
            accumulatedScroll = 0;

            // Po zako≈Ñczeniu animacji smooth, snap do najbli≈ºszej kolumny
            // Smooth scroll trwa ~300-500ms, wiƒôc czekamy d≈Çu≈ºej
            setTimeout(() => {
                snapToNearestColumn(container, columnWidth);
            }, 400); // Czekaj na zako≈Ñczenie smooth scroll
        }

        // Snap do najbli≈ºszej kolumny
        function snapToNearestColumn(container, columnWidth) {
            const currentScroll = container.scrollLeft;
            const nearestColumn = Math.round(currentScroll / columnWidth) * columnWidth;

            // Tylko snap je≈õli r√≥≈ºnica jest znaczƒÖca (> 5px)
            if (Math.abs(currentScroll - nearestColumn) > 5) {
                container.scrollTo({ 
                    left: nearestColumn, 
                    behavior: 'smooth' 
                });        
            }
        }

        // Wywo≈Çaj po za≈Çadowaniu strony
        document.addEventListener('DOMContentLoaded', function() {
            enableHorizontalScrollOnWheel();
        });

   
    </script>
</body>
</html>