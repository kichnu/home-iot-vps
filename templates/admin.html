<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>
        {% if device_context %}
            {{ device_context.icon }} {{ device_context.name }} - Admin Panel
        {% else %}
            üê† Water System Admin Panel
        {% endif %}
    </title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        /* CSS Variables dla device context - ustawiane przez JavaScript */
        :root {
            --device-color: #3498db;
            --device-color-light: rgba(52, 152, 219, 0.2);
            --device-color-medium: rgba(52, 152, 219, 0.4);
            --device-color-dark: rgba(52, 152, 219, 0.8);
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        /* Device-specific body classes */
        body.device-context {
            background: linear-gradient(135deg, var(--device-color-light) 0%, var(--device-color-medium) 100%);
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, var(--device-color) 0%, var(--device-color-dark) 100%);
            color: white;
            padding: 20px 30px;
            position: relative;
        }

        .header h1 {
            font-size: 28px;
            margin-bottom: 5px;
        }

        .header .subtitle {
            opacity: 0.9;
            font-size: 14px;
        }

        .header-controls {
            position: absolute;
            top: 20px;
            right: 30px;
            display: flex;
            gap: 15px;
            align-items: center;
        }

        .dashboard-btn {
            background: rgba(255,255,255,0.2);
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s;
            text-decoration: none;
        }

        .dashboard-btn:hover {
            background: rgba(255,255,255,0.3);
            transform: translateY(-1px);
        }

        .session-info {
            background: rgba(255,255,255,0.1);
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 12px;
            backdrop-filter: blur(10px);
        }

        .logout-btn {
            background: #e74c3c;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s;
        }

        .logout-btn:hover {
            background: #c0392b;
            transform: translateY(-1px);
        }

        .content {
            padding: 30px;
        }

        .section {
            margin-bottom: 30px;
        }

        .section h2 {
            color: #2c3e50;
            margin-bottom: 15px;
            font-size: 20px;
            border-bottom: 2px solid var(--device-color);
            padding-bottom: 5px;
        }

        .quick-queries {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .quick-btn {
            background: linear-gradient(135deg, var(--device-color), var(--device-color-dark));
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s;
            font-size: 14px;
        }

        .quick-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px var(--device-color-medium);
        }

        .quick-btn:active {
            transform: translateY(0);
        }

        .sql-editor {
            margin-bottom: 20px;
        }

        .sql-textarea {
            width: 100%;
            padding: 15px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
            font-size: 14px;
            resize: vertical;
            background: #f8f9fa;
        }

        .sql-textarea:focus {
            outline: none;
            border-color: var(--device-color);
            background: white;
        }

        .execute-section {
            display: flex;
            gap: 10px;
            align-items: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .execute-btn {
            background: linear-gradient(135deg, #27ae60, #229954);
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            font-size: 16px;
            transition: all 0.3s;
        }

        .execute-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(39, 174, 96, 0.4);
        }

        .execute-btn:disabled {
            background: #95a5a6;
            cursor: not-allowed;
            transform: none;
        }

        .export-section {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .export-btn {
            background: linear-gradient(135deg, #e74c3c, #c0392b);
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 12px;
            text-decoration: none;
            display: inline-block;
            transition: all 0.3s;
        }

        .export-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 3px 10px rgba(231, 76, 60, 0.4);
        }

        .results-section {
            margin-top: 20px;
        }

        .results-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            flex-wrap: wrap;
            gap: 10px;
        }

        .results-info {
            color: #7f8c8d;
            font-size: 14px;
        }

        .results-table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            max-height: 500px;
            overflow-y: auto;
            display: block;
            position: relative;
        }

        .results-table thead,
        .results-table tbody {
            display: table;
            width: 100%;
            table-layout: fixed;
        }

        .results-table thead {
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .results-table th,
        .results-table td {
            padding: 8px 4px;
            text-align: center;
            border-bottom: 1px solid #ecf0f1;
            border-right: 1px solid #ecf0f1;
            word-wrap: break-word;
            overflow-wrap: break-word;
            vertical-align: middle;
        }

        .results-table th {
            color: black;
            font-weight: bold;
            height: 180px;
            min-height: 80px;
            position: relative;
            white-space: nowrap;
        }

        .results-table th span {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) rotate(-90deg);
            transform-origin: center center;
            white-space: nowrap;
            font-size: 14px;
            font-weight: bold;
            letter-spacing: 0.5px;
        }

        .results-table.few-columns th {
            height: auto;
            min-height: 40px;
        }

        .results-table.few-columns th span {
            transform: translate(-50%, -50%) rotate(0deg);
            position: static;
            transform: none;
            display: block;
            padding: 10px;
            font-size: 13px;
        }

        .results-table td {
            font-size: 12px;
            max-width: 100px;
            padding: 4px 4px;
        }

        /* Device-type specific column styling */
        .th-id, .th-device_id, .th-timestamp, .th-event_type, .th-received_at {
            background-color: #a6b5c5;
        }

        .th-pump_duration, .th-pump_attempts, .th-volume_ml, .th-time_gap_1, 
        .th-time_gap_2, .th-water_trigger_time {
            background-color: rgb(106, 191, 248);
        }

        .th-gap1_fail_sum, .th-gap2_fail_sum, .th-water_fail_sum {
            background-color: rgb(252, 107, 107);
        }

        .th-temperature, .th-humidity {
            background-color: #f39c12;
        }

        .th-zone_status, .th-motion_detected {
            background-color: #95a5a6;
        }

        .th-device_type {
            background-color: #9b59b6;
        }

        .row-auto-pump {
            background-color: #e3f2fd; 
        }

        .row-manual-normal {
            background-color: #e8f5e8; 
        }

        .row-manual-extended {
            background-color: #fd8f8f;
        }

        .row-auto-complete {
            background-color: #f3e5f5;
        }

        .row-stats-reset {
            background-color: #979797;
        }

        .row-default {
            background-color: white;
        }

        @media (max-width: 768px) {
            .content {
                padding: 20px;
            }

            .header-controls {
                position: static;
                margin-top: 15px;
                justify-content: flex-start;
            }

            .quick-queries {
                grid-template-columns: 1fr;
            }

            .execute-section {
                flex-direction: column;
                align-items: stretch;
            }

            .execute-btn,
            .export-btn {
                width: 100%;
                margin: 5px 0;
            }

            .results-table {
                font-size: 12px;
            }

            .results-table th,
            .results-table td {
                padding: 8px 4px;
            }
        }

        .alert {
            padding: 15px;
            margin: 15px 0;
            border-radius: 8px;
            font-weight: bold;
        }

        .alert.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .alert.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .alert.info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }

        .alert.warning {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }

        .loading {
            text-align: center;
            padding: 20px;
            color: #7f8c8d;
        }

        .loading::after {
            content: '';
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid var(--device-color);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-left: 10px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .no-results {
            text-align: center;
            padding: 40px;
            color: #7f8c8d;
            font-style: italic;
        }

        .session-warning {
            position: fixed;
            top: 20px;
            right: 20px;
            background: #f39c12;
            color: white;
            padding: 15px 20px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
            display: none;
            z-index: 1000;
        }

        .help-section {
            background: #ecf0f1;
            padding: 20px;
            border-radius: 8px;
            margin-top: 20px;
        }

        .help-section h3 {
            color: #2c3e50;
            margin-bottom: 10px;
        }

        .help-section code {
            background: #34495e;
            color: white;
            padding: 2px 6px;
            border-radius: 4px;
            font-family: monospace;
        }

        .help-section ul {
            margin-left: 20px;
        }

        .help-section li {
            margin: 5px 0;
        }
</style>
</head>
<body {% if device_context %}class="device-type-{{ device_context.type }}"{% endif %}>
    <div class="session-warning" id="sessionWarning">
        ‚ö†Ô∏è Session expires in <span id="warningTime">5</span> minutes. Click to extend.
    </div>

    <div class="container">
        <div class="header">
            <h1>
                {% if device_context %}
                    {{ device_context.icon }} {{ device_context.name }} - Admin Panel
                {% else %}
                    üê† Aquarium System Database - Admin Panel
                {% endif %}
            </h1>
            <div class="subtitle">
                {% if device_context %}
                    {{ device_context.description }} - Device Management Interface
                {% else %}
                    Multi-device IoT management interface
                {% endif %}
            </div>
            <div class="header-controls">
                <a href="/dashboard" class="dashboard-btn">
                    üè† Dashboard
                </a>
                <div class="session-info" id="sessionInfo">
                    Loading session info...
                </div>
                <button class="logout-btn" onclick="logout()">
                    Logout
                </button>
            </div>
        </div>

        <div class="content">
            <!-- Quick Queries Section -->
            <div class="section">
                <h2>üìä Quick Queries
                    {% if device_context %}
                        - {{ device_context.name }}
                    {% endif %}
                </h2>
         
                <div class="quick-queries" id="quickQueriesContainer">
                    <!-- Quick queries will be loaded dynamically -->
                </div>
            </div>

            <!-- Results Section -->
            <div class="section">
                <div class="results-header">
                    <h2>üìã Query Results</h2>
                    <div class="results-info" id="resultsInfo">Ready for query</div>
                </div>
                
                <div id="resultsContainer">
                    <div class="no-results">Enter a SQL query and click Execute to see results</div>
                </div>
            </div>

            <!-- Custom SQL Query Section -->
            <div class="section">
                <h2>üíª Custom SQL Query</h2>
                <div class="sql-editor">
                    <textarea 
                        id="sqlQuery" 
                        class="sql-textarea" 
                        placeholder="SELECT * FROM water_events WHERE device_type = '{{ device_context.type if device_context else 'water_system' }}' ORDER BY received_at DESC LIMIT 50;"
                    ></textarea>
                </div>
                
                <div class="execute-section">
                    <button class="execute-btn" onclick="executeCustomQuery()" id="executeBtn">
                        Execute Query
                    </button>
                    
                    <div class="export-section" id="exportSection" style="display: none;">
                        <span>Export:</span>
                        <a href="#" class="export-btn" id="exportCsv">CSV</a>
                        <a href="#" class="export-btn" id="exportJson">JSON</a>
                    </div>
                </div>
            </div>
            
            <!-- Help Section -->
            <div class="help-section">
                <h3>üìö Help & Examples
                    {% if device_context %}
                        - {{ device_context.name }}
                    {% endif %}
                </h3>
                <p><strong>Available table:</strong> <code>water_events</code></p>
                {% if device_context %}
                <p><strong>Relevant columns for {{ device_context.name }}:</strong> 
                    {% for column in device_context.columns %}
                        <code>{{ column }}</code>{% if not loop.last %}, {% endif %}
                    {% endfor %}
                </p>
                <p><strong>Event types:</strong> 
                    {% for event_type in device_context.event_types %}
                        <code>{{ event_type }}</code>{% if not loop.last %}, {% endif %}
                    {% endfor %}
                </p>
                {% else %}
                <p><strong>Columns:</strong> id, device_id, device_type, timestamp, unix_time, event_type, volume_ml, water_status, system_status, received_at, client_ip, temperature, humidity, zone_status, motion_detected</p>
                {% endif %}
                <p><strong>Example queries:</strong></p>
                <ul>
                    {% if device_context and device_context.type == 'water_system' %}
                    <li><code>SELECT * FROM water_events WHERE device_type = 'water_system' AND event_type = 'AUTO_CYCLE_COMPLETE' LIMIT 10;</code> - Auto pump cycles</li>
                    <li><code>SELECT DATE(received_at), SUM(volume_ml) FROM water_events WHERE device_type = 'water_system' GROUP BY DATE(received_at);</code> - Daily volume</li>
                    <li><code>SELECT * FROM water_events WHERE device_type = 'water_system' AND pump_attempts > 1;</code> - Multiple pump attempts</li>
                    {% elif device_context and device_context.type == 'temperature_sensor' %}
                    <li><code>SELECT * FROM water_events WHERE device_type = 'temperature_sensor' AND temperature IS NOT NULL LIMIT 10;</code> - Temperature readings</li>
                    <li><code>SELECT AVG(temperature), AVG(humidity) FROM water_events WHERE device_type = 'temperature_sensor' AND DATE(received_at) = DATE('now');</code> - Today's averages</li>
                    {% elif device_context and device_context.type == 'security_system' %}
                    <li><code>SELECT * FROM water_events WHERE device_type = 'security_system' AND motion_detected = 1 LIMIT 10;</code> - Motion events</li>
                    <li><code>SELECT zone_status, COUNT(*) FROM water_events WHERE device_type = 'security_system' GROUP BY zone_status;</code> - Zone status summary</li>
                    {% else %}
                    <li><code>SELECT COUNT(*) FROM water_events;</code> - Total events count</li>
                    <li><code>SELECT device_type, COUNT(*) FROM water_events GROUP BY device_type;</code> - Events by device type</li>
                    <li><code>SELECT * FROM water_events WHERE system_status != 'OK';</code> - System issues</li>
                    {% endif %}
                </ul>
                <p><strong>Restrictions:</strong></p>
                <ul>
                    <li>Only SELECT queries allowed</li>
                    <li>Maximum 1000 results</li>
                    <li>10 second query timeout</li>
                    <li>Only water_events table accessible</li>
                </ul>
            </div>
        </div>
    </div>

    <script>

        // {% if device_context %}
        document.documentElement.style.setProperty('--device-color', '{{ device_context.color }}');
        document.documentElement.style.setProperty('--device-color-light', '{{ device_context.color }}22');
        document.documentElement.style.setProperty('--device-color-medium', '{{ device_context.color }}66');
        document.documentElement.style.setProperty('--device-color-dark', '{{ device_context.color }}CC');
        document.body.classList.add('device-context');
        // {% endif %}

        let currentQueryType = '';
        let currentDeviceType = '{{ device_context.type if device_context else "" }}';
        let sessionTimer = null;
        let warningShown = false;

        // Device-specific column translation
        function translateColumnName(columnName) {
            const baseTranslations = {
                'id': 'ID',
                'device_id': 'Device ID',
                'device_type': 'Device Type',
                'timestamp': 'Event Time',
                'unix_time': 'Unix Time',
                'event_type': 'Event Type',
                'water_status': 'Water Status',
                'system_status': 'System Status',
                'received_at': 'Log Receipt Time',
                'client_ip': 'Client IP'
            };

            const deviceSpecificTranslations = {
                'water_system': {
                    'volume_ml': 'Water Volume (ml)',
                    'time_gap_1': 'Turn-ON Delay',
                    'time_gap_2': 'Turn-OFF Delay',
                    'water_trigger_time': 'Water Fill Delay',
                    'pump_duration': 'Pump Run Time',
                    'pump_attempts': 'Pump Attempts',
                    'gap1_fail_sum': 'Turn-ON Error Count',
                    'gap2_fail_sum': 'Turn-OFF Error Count', 
                    'water_fail_sum': 'Water Fill Errors',
                    'last_reset_timestamp': 'Last Reset',
                    'algorithm_data': 'Event Log'
                },
                'temperature_sensor': {
                    'temperature': 'Temperature (¬∞C)',
                    'humidity': 'Humidity (%)',
                },
                'security_system': {
                    'zone_status': 'Zone Status',
                    'motion_detected': 'Motion Detected'
                }
            };
            
            // Check device-specific translations first
            if (currentDeviceType && deviceSpecificTranslations[currentDeviceType] && deviceSpecificTranslations[currentDeviceType][columnName]) {
                return deviceSpecificTranslations[currentDeviceType][columnName];
            }
            
            // Fall back to base translations
            return baseTranslations[columnName] || columnName;
        }

        // Load available queries for device type
        function loadDeviceQueries() {
            if (!currentDeviceType) {
                loadLegacyQueries();
                return;
            }

            fetch(`/api/available-queries/${currentDeviceType}`)
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        const container = document.getElementById('quickQueriesContainer');
                        container.innerHTML = '';
                        
                        Object.entries(data.queries).forEach(([queryId, queryInfo]) => {
                            const btn = document.createElement('button');
                            btn.className = 'quick-btn';
                            btn.textContent = queryInfo.name;
                            btn.title = queryInfo.description;
                            btn.onclick = () => executeDeviceQuery(queryId);
                            container.appendChild(btn);
                        });
                    } else {
                        console.error('Failed to load device queries:', data.error);
                        loadLegacyQueries();
                    }
                })
                .catch(error => {
                    console.error('Error loading device queries:', error);
                    loadLegacyQueries();
                });
        }

        function loadLegacyQueries() {
            const container = document.getElementById('quickQueriesContainer');
            container.innerHTML = `
                <button class="quick-btn" onclick="executeQuickQuery('last24h')">Last 24 Hours</button>
                <button class="quick-btn" onclick="executeQuickQuery('last_100_events')">Last 100 Events</button>
                <button class="quick-btn" onclick="executeQuickQuery('all_events')">All Events</button>
                <button class="quick-btn" onclick="executeQuickQuery('errors')">Errors</button>
                <button class="quick-btn" onclick="executeQuickQuery('today_stats')">Today's Stats</button>
            `;
        }

        function executeDeviceQuery(queryType) {
            currentQueryType = queryType;
            const container = document.getElementById('resultsContainer');
            container.innerHTML = '<div class="loading">Executing query...</div>';
            
            const url = currentDeviceType 
                ? `/api/admin-device-query/${currentDeviceType}/${queryType}`
                : `/api/admin-quick-query/${queryType}`;
            
            fetch(url)
                .then(response => {
                    if (response.status === 401) {
                        alert('Session expired. Please login again.');
                        window.location.href = '/login';
                        return;
                    }
                    return response.json();
                })
                .then(data => {
                    if (data && data.success) {
                        displayResults(data.data);
                        updateResultsInfo(data.count);
                    } else if (data) {
                        showAlert(`Error: ${data.error}`, 'error');
                    }
                })
                .catch(error => {
                    showAlert(`Network error: ${error.message}`, 'error');
                });
        }
  
        // Mapowanie warto≈õci na polskie
        function translateCellValue(columnName, value) {

            if (columnName === 'timestamp' && value) {
                return value.replace(/\s*\([^)]*\)\s*$/, '');
            }

            const valueTranslations = {
                'event_type': {
                    'AUTO_PUMP': 'AUTO PUMP',
                    'MANUAL_NORMAL': 'MANUAL FILL',
                    'MANUAL_EXTENDED': 'PUMP CALIBRATION',
                    'AUTO_CYCLE_COMPLETE': 'AUTO FILL',
                    'STATISTICS_RESET': 'STATISTICS RESET',
                    'TEMP_READING': 'TEMP READING',
                    'HUMIDITY_READING': 'HUMIDITY READING',
                    'SENSOR_ERROR': 'SENSOR ERROR',
                    'DOOR_OPEN': 'DOOR OPEN',
                    'DOOR_CLOSE': 'DOOR CLOSE',
                    'MOTION_DETECTED': 'MOTION DETECTED',
                    'SYSTEM_ARM': 'SYSTEM ARM',
                    'SYSTEM_DISARM': 'SYSTEM DISARM'
                },
                'water_status': {
                    'OK': 'OK',
                    'NORMAL': 'NORMAL',
                    'LOW': 'LOW  ',
                    'BOTH_LOW': 'BOTH LOW',
                    'SENSOR1_LOW': 'SENSOR 1 LOW',
                    'SENSOR2_LOW': 'SENSOR 2 LOW',
                    'PARTIAL': 'PARTIAL',
                    'CHECKING': 'CHECKING'
                },
                'system_status': {
                    'OK': 'SYSTEM OK',
                    'ERROR': 'ERROR'
                },
                'zone_status': {
                    'ARMED': 'ARMED',
                    'DISARMED': 'DISARMED',
                    'OPEN': 'OPEN',
                    'CLOSED': 'CLOSED',
                    'TRIGGERED': 'TRIGGERED'
                },
                'motion_detected': {
                    '1': 'YES',
                    '0': 'NO',
                    'true': 'YES',
                    'false': 'NO'
                }
            };
            
            if (valueTranslations[columnName] && valueTranslations[columnName][value]) {
                return valueTranslations[columnName][value];
            }
            return value;
        }

        // Load session info on page load
        function loadSessionInfo() {
            fetch('/api/session-info')
                .then(response => response.json())
                .then(data => {
                    const sessionInfo = document.getElementById('sessionInfo');
                    const loginTime = new Date(data.login_time).toLocaleTimeString();
                    sessionInfo.innerHTML = `
                        üïí ${loginTime}<br>
                        <small>IP: ${data.client_ip}</small>
                    `;
                    
                    // Start session timer
                    startSessionTimer(data.timeout_minutes);
                })
                .catch(error => {
                    console.error('Failed to load session info:', error);
                });
        }

        function startSessionTimer(timeoutMinutes) {
            const totalMs = timeoutMinutes * 60 * 1000;
            const warningMs = 5 * 60 * 1000; // 5 minutes warning
            
            setTimeout(() => {
                showSessionWarning();
            }, totalMs - warningMs);
        }

        function showSessionWarning() {
            if (warningShown) return;
            warningShown = true;
            
            const warning = document.getElementById('sessionWarning');
            warning.style.display = 'block';
            
            let timeLeft = 5 * 60; // 5 minutes in seconds
            const warningTimeSpan = document.getElementById('warningTime');
            
            const countdown = setInterval(() => {
                const minutes = Math.floor(timeLeft / 60);
                const seconds = timeLeft % 60;
                warningTimeSpan.textContent = `${minutes}:${seconds.toString().padStart(2, '0')}`;
                timeLeft--;
                
                if (timeLeft < 0) {
                    clearInterval(countdown);
                    alert('Session expired. You will be redirected to login page.');
                    window.location.href = '/login';
                }
            }, 1000);
            
            // Click warning to extend session (make any API call)
            warning.onclick = () => {
                fetch('/api/session-info')
                    .then(() => {
                        warning.style.display = 'none';
                        warningShown = false;
                        clearInterval(countdown);
                        showAlert('Session extended successfully', 'success');
                    });
            };
        }

        function showAlert(message, type) {
            const resultsContainer = document.getElementById('resultsContainer');
            const alert = document.createElement('div');
            alert.className = 'alert ' + type;
            alert.textContent = message;
            
            // Insert at top of results container
            resultsContainer.insertBefore(alert, resultsContainer.firstChild);
            
            setTimeout(() => {
                if (resultsContainer.contains(alert)) {
                    resultsContainer.removeChild(alert);
                }
            }, 5000);
        }

        function updateResultsInfo(count, limited = false) {
            const info = document.getElementById('resultsInfo');
            let text = `${count} rows returned`;
            if (limited) {
                text += ' (limited to 1000)';
            }
            info.textContent = text;
        }

        function displayResults(data) {
            const container = document.getElementById('resultsContainer');
            
            if (!data || data.length === 0) {
                container.innerHTML = '<div class="no-results">No results found</div>';
                updateResultsInfo(0);
                document.getElementById('exportSection').style.display = 'none';
                return;
            }

            // Create table
            const table = document.createElement('table');
            table.className = 'results-table';

            // Create header
            const thead = document.createElement('thead');
            const headerRow = document.createElement('tr');

            const preferredColumnOrder = [
                'id','device_id', 'device_type', 'timestamp', 'event_type', 'pump_duration', 'pump_attempts', 'volume_ml', 'time_gap_1', 'time_gap_2'
                , 'water_trigger_time','gap1_fail_sum', 'gap2_fail_sum', 'water_fail_sum', 'temperature', 'humidity', 'zone_status', 'motion_detected', 'system_status',
                 'client_ip', 'water_status', 'received_at', 'last_reset_timestamp',
                , 'unix_time', 'algorithm_data', 
            ];

            const columnCategories = {
                'id': 'th-id',
                'device_id': 'th-device_id',
                'device_type': 'th-device_type',
                'timestamp': 'th-timestamp',
                'event_type': 'th-event_type',
                'pump_duration': 'th-pump_duration',
                'pump_attempts': 'th-pump_attempts',
                'volume_ml': 'th-volume_ml',
                'time_gap_1': 'th-time_gap_1',
                'time_gap_2': 'th-time_gap_2',
                'water_trigger_time': 'th-water_trigger_time',
                'gap1_fail_sum': 'th-gap1_fail_sum',
                'gap2_fail_sum': 'th-gap2_fail_sum',
                'water_fail_sum': 'th-water_fail_sum',
                'temperature': 'th-temperature',
                'humidity': 'th-humidity',
                'zone_status': 'th-zone_status',
                'motion_detected': 'th-motion_detected',
                'client_ip': 'th-client_ip',
                'water_status': 'th-water_status',
                'system_status': 'th-system_status',
                'received_at': 'th-received_at',
                'last_reset_timestamp': 'th-last_reset_timestamp',
                'unix_time': 'th-unik_time',
                'algorithm_data': 'th-algorithm_data',
            };

            const availableColumns = Object.keys(data[0]);
            const columnKeys = preferredColumnOrder.filter(col => availableColumns.includes(col))
                             .concat(availableColumns.filter(col => !preferredColumnOrder.includes(col)));
            
            columnKeys.forEach(key => {
                const th = document.createElement('th');
                const span = document.createElement('span');
                span.textContent = translateColumnName(key);
                th.appendChild(span);

                const categoryClass = columnCategories[key] || 'th-default';
                th.classList.add(categoryClass);

                headerRow.appendChild(th);
            });

            thead.appendChild(headerRow);
            table.appendChild(thead);

            // Sprawd≈∫ liczbƒô kolumn i dodaj klasƒô CSS
            if (columnKeys.length < 8) {
                table.classList.add('few-columns');
            }

            // Create body
            const tbody = document.createElement('tbody');
            
            data.forEach(row => {
                const tr = document.createElement('tr');

                    const eventType = row['event_type'];
                if (eventType) {
                    const rowClass = getEventTypeRowClass(eventType);
                    tr.classList.add(rowClass);
                }

                columnKeys.forEach(columnName => {
                    const td = document.createElement('td');
                    const value = row[columnName];
                    const translatedValue = translateCellValue(columnName, value);
                    td.textContent = (translatedValue !== null && translatedValue !== undefined) ? translatedValue : '';
                    tr.appendChild(td);
                });
                tbody.appendChild(tr);
            });
            
            table.appendChild(tbody);
            container.innerHTML = '';
            container.appendChild(table);

            // Show export options
            document.getElementById('exportSection').style.display = 'flex';
            setupExportLinks();
        }

        function getEventTypeRowClass(eventType) {
            const eventTypeClasses = {
                'AUTO_PUMP': 'row-auto-pump',
                'MANUAL_NORMAL': 'row-manual-normal', 
                'MANUAL_EXTENDED': 'row-manual-extended',
                'AUTO_CYCLE_COMPLETE': 'row-auto-complete',
                'STATISTICS_RESET': 'row-stats-reset',
                'TEMP_READING': 'row-default',
                'HUMIDITY_READING': 'row-default',
                'SENSOR_ERROR': 'row-manual-extended',
                'DOOR_OPEN': 'row-default',
                'DOOR_CLOSE': 'row-default',
                'MOTION_DETECTED': 'row-manual-extended',
                'SYSTEM_ARM': 'row-default',
                'SYSTEM_DISARM': 'row-default'
            };
            return eventTypeClasses[eventType] || 'row-default';
        }

        function setupExportLinks() {
            const csvLink = document.getElementById('exportCsv');
            const jsonLink = document.getElementById('exportJson');
            csvLink.onclick = () => exportData('csv');
            jsonLink.onclick = () => exportData('json');
        }

        function exportData(format) {
            if (!currentQueryType) {
                showAlert('No query to export', 'error');
                return;
            }
        
            const url = currentDeviceType 
                ? `/api/quick-export/${currentDeviceType}/${currentQueryType}/${format}`
                : `/api/quick-export/${currentQueryType}/${format}`;
                
            window.open(url, '_blank');
        }       

        function executeQuery(query, isQuick = false) {
            if (!query.trim()) {
                showAlert('Please enter a SQL query', 'error');
                return;
            }

            const container = document.getElementById('resultsContainer');
            container.innerHTML = '<div class="loading">Executing query...</div>';
            const executeBtn = document.getElementById('executeBtn');
            executeBtn.disabled = true;
            executeBtn.textContent = 'Executing...';
            const endpoint = isQuick ? `/api/admin-quick-query/${query}` : '/api/admin-query';
            const requestData = isQuick ? null : { query: query };

            fetch(endpoint, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: requestData ? JSON.stringify(requestData) : null
            })
            .then(response => {
                if (response.status === 401) {
                    // Session expired
                    alert('Session expired. Please login again.');
                    window.location.href = '/login';
                    return;
                }
                return response.json();
            })
            .then(data => {
                if (data && data.success) {
                    displayResults(data.data);
                    updateResultsInfo(data.count, data.limited);
                    
                    if (data.limited) {
                        showAlert('Results limited to 1000 rows. Use LIMIT clause for specific ranges.', 'info');
                    }

                } else if (data) {
                    showAlert(`Error: ${data.error}`, 'error');
                    document.getElementById('exportSection').style.display = 'none';
                }
            })
            .catch(error => {
                showAlert(`Network error: ${error.message}`, 'error');
                document.getElementById('exportSection').style.display = 'none';
            })
            .finally(() => {
                executeBtn.disabled = false;
                executeBtn.textContent = 'Execute Query';
            });
        }

        function executeCustomQuery() {
            const query = document.getElementById('sqlQuery').value;
            executeQuery(query, false);
        }

        function executeQuickQuery(type) {
            executeDeviceQuery(type);
        }

        function logout() {
            if (confirm('Are you sure you want to logout?')) {
                fetch('/logout', { method: 'POST' })
                    .then(() => {
                        window.location.href = '/login';
                    })
                    .catch(() => {
                        // Even if request fails, redirect to login
                        window.location.href = '/login';
                    });
            }
        }

        // Load default query on page load
        document.addEventListener('DOMContentLoaded', function() {
            
            const defaultQuery = currentDeviceType 
                ? `SELECT * FROM water_events WHERE device_type = '${currentDeviceType}' ORDER BY received_at DESC LIMIT 20;`
                : 'SELECT * FROM water_events ORDER BY received_at DESC LIMIT 20;';
            
            document.getElementById('sqlQuery').value = defaultQuery;
            loadSessionInfo();
            loadDeviceQueries();
        });

        // Execute query on Ctrl+Enter
        document.getElementById('sqlQuery').addEventListener('keydown', function(e) {
            if (e.ctrlKey && e.key === 'Enter') {
                executeCustomQuery();
            }
        });

        // Heartbeat to keep session alive during active use
        setInterval(() => {
            if (!warningShown) {
                fetch('/api/session-info')
                    .catch(() => {
                        console.log('Session check failed');
                    });
            }
        }, 5 * 60 * 1000); // Every 5 minutes
    </script>
</body>
</html>