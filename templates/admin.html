<!DOCTYPE html>
<html lang="en">
<head>
    <!-- TEST v2 -->

    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üê† Water System Admin Panel</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
          

            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #2c3e50 0%, #3498db 100%);
            color: white;
            padding: 20px 30px;
            position: relative;
        }

        .header h1 {
            font-size: 28px;
            margin-bottom: 5px;
        }

        .header .subtitle {
            opacity: 0.9;
            font-size: 14px;
        }

        .header-controls {
            position: absolute;
            top: 20px;
            right: 30px;
            display: flex;
            gap: 15px;
            align-items: center;
        }

        .session-info {
            background: rgba(255,255,255,0.1);
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 12px;
            backdrop-filter: blur(10px);
        }

        .logout-btn {
            background: #e74c3c;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s;
        }

        .logout-btn:hover {
            background: #c0392b;
            transform: translateY(-1px);
        }

        .content {
            padding: 30px;
        }

        .section {
            margin-bottom: 30px;
        }

        .section h2 {
            color: #2c3e50;
            margin-bottom: 15px;
            font-size: 20px;
            border-bottom: 2px solid #3498db;
            padding-bottom: 5px;
        }

        .quick-queries {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .quick-btn {
            background: linear-gradient(135deg, #3498db, #2980b9);
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s;
            font-size: 14px;
        }

        .quick-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(52, 152, 219, 0.4);
        }

        .quick-btn:active {
            transform: translateY(0);
        }

        .sql-editor {
            margin-bottom: 20px;
        }

        .sql-textarea {
            width: 100%;
            padding: 15px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
            font-size: 14px;
            resize: vertical;
            background: #f8f9fa;
        }

        .sql-textarea:focus {
            outline: none;
            border-color: #3498db;
            background: white;
        }

        .execute-section {
            display: flex;
            gap: 10px;
            align-items: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .execute-btn {
            background: linear-gradient(135deg, #27ae60, #229954);
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            font-size: 16px;
            transition: all 0.3s;
        }

        .execute-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(39, 174, 96, 0.4);
        }

        .execute-btn:disabled {
            background: #95a5a6;
            cursor: not-allowed;
            transform: none;
        }

        .export-section {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .export-btn {
            background: linear-gradient(135deg, #e74c3c, #c0392b);
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 12px;
            text-decoration: none;
            display: inline-block;
            transition: all 0.3s;
        }

        .export-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 3px 10px rgba(231, 76, 60, 0.4);
        }

        .results-section {
            margin-top: 20px;
        }

        .results-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            flex-wrap: wrap;
            gap: 10px;
        }

        .results-info {
            color: #7f8c8d;
            font-size: 14px;
        }




        /* .results-table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            max-height: 500px;
            overflow-y: auto;
            display: block;
        }

        .results-table thead,
        .results-table tbody {
            display: table;
            width: 100%;
            table-layout: fixed;
        }

        .results-table th,
        .results-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #ecf0f1;
            word-wrap: break-word;
            overflow-wrap: break-word;
        }

        .results-table th {
            background: #34495e;
            color: white;
            font-weight: bold;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .results-table tbody tr:hover {
            background: #f8f9fa;
        }

        .results-table tbody tr:nth-child(even) {
            background: #fafbfc;
        } */

        .results-table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            max-height: 500px;
            overflow-y: auto;
            display: block;
            position: relative;
        }

        .results-table thead,
        .results-table tbody {
            display: table;
            width: 100%;
            table-layout: fixed;
        }

        .results-table thead {
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .results-table th,
        .results-table td {
            padding: 8px 4px;
            text-align: center;
            border-bottom: 1px solid #ecf0f1;
            border-right: 1px solid #ecf0f1;
            word-wrap: break-word;
            overflow-wrap: break-word;
            vertical-align: middle;
        }

        .results-table th {
            /* background: #a6b5c5; */
            color: black;
            font-weight: bold;
            height: 180px;
            min-height: 80px;
            position: relative;
            white-space: nowrap;
        }

        .results-table th span {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) rotate(-90deg);
            transform-origin: center center;
            white-space: nowrap;
            font-size: 14px;
            font-weight: bold;
            letter-spacing: 0.5px;
        }

                /* Gdy kolumn jest ma≈Ço (<8) - wy≈ÇƒÖcz obr√≥t */
        .results-table.few-columns th {
            height: auto;
            min-height: 40px;
        }

        .results-table.few-columns th span {
            transform: translate(-50%, -50%) rotate(0deg);
            position: static;
            transform: none;
            display: block;
            padding: 10px;
            font-size: 13px;
        }

        .results-table td {
            font-size: 12px;
            max-width: 100px;
            padding: 4px 4px;
        }

        .th-id{
            background-color: #a6b5c5;
        }

        .th-device_id{
            background-color: #a6b5c5;
        }

        .th-timestamp{
            background-color: #a6b5c5;
        }

        .th-event_type{
            background-color: #a6b5c5;
        }

        .th-pump_duration{
            background-color: rgb(106, 191, 248);
        }

        .th-pump_attempts{
            background-color: rgb(106, 191, 248);
        }
        
        .th-volume_ml{
            background-color: rgb(106, 191, 248);
        }

        .th-time_gap_1{
            background-color: rgb(106, 191, 248);
        }

        .th-time_gap_2{
            background-color: rgb(106, 191, 248);
        }

        .th-water_trigger_time{
            background-color: rgb(106, 191, 248);
        }

        .th-gap1_fail_sum{
            background-color: rgb(252, 107, 107);
        }

        .th-gap2_fail_sum{
            background-color: rgb(252, 107, 107);
        }

        .th-water_fail_sum{
            background-color: rgb(252, 107, 107);
        }

        .th-client_ip{
            background-color: #a6b5c5;
        }

        .th-water_status{
            background-color: #a6b5c5;
        }

        .th-system_status{
            background-color: #a6b5c5;
        }

        .th-received_at{
            background-color: #a6b5c5;
        }

        .th-last_reset_timestamp{
            background-color: #a6b5c5;
        }

        .th-unik_time{
            background-color: #a6b5c5;
        }

        .th-algorithm_data{
            background-color: #a6b5c5;
        }



        .row-auto-pump {
            background-color: #e3f2fd; /* jasny niebieski */
        }

        .row-manual-normal {
            background-color: #e8f5e8; /* jasny zielony */
        }

        .row-manual-extended {
            background-color: #fd8f8f; /* jasny pomara≈Ñczowy */
        }

        .row-auto-complete {
            background-color: #f3e5f5; /* jasny fioletowy */
        }

        .row-stats-reset {
            background-color: #979797; /* jasny ≈º√≥≈Çty dla reset√≥w */
        }

        .row-default {
            background-color: white; /* domy≈õlny szary */
        }

        /* Responsywno≈õƒá dla ma≈Çych ekran√≥w */
        @media (max-width: 768px) {
            .results-table th {
                height: 60px;
                min-height: 60px;
            }
            
            .results-table th span {
                font-size: 10px;
            }
            
            .results-table td {
                font-size: 10px;
                padding: 4px 2px;
            }
        }

        .alert {
            padding: 15px;
            margin: 15px 0;
            border-radius: 8px;
            font-weight: bold;
        }

        .alert.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .alert.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .alert.info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }

        .alert.warning {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }

        .loading {
            text-align: center;
            padding: 20px;
            color: #7f8c8d;
        }

        .loading::after {
            content: '';
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #3498db;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-left: 10px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .no-results {
            text-align: center;
            padding: 40px;
            color: #7f8c8d;
            font-style: italic;
        }

        .session-warning {
            position: fixed;
            top: 20px;
            right: 20px;
            background: #f39c12;
            color: white;
            padding: 15px 20px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
            display: none;
            z-index: 1000;
        }

        @media (max-width: 768px) {
            .content {
                padding: 20px;
            }

            .header-controls {
                position: static;
                margin-top: 15px;
                justify-content: flex-start;
            }

            .quick-queries {
                grid-template-columns: 1fr;
            }

            .execute-section {
                flex-direction: column;
                align-items: stretch;
            }

            .execute-btn,
            .export-btn {
                width: 100%;
                margin: 5px 0;
            }

            .results-table {
                font-size: 12px;
            }

            .results-table th,
            .results-table td {
                padding: 8px 4px;
            }
        }

        .help-section {
            background: #ecf0f1;
            padding: 20px;
            border-radius: 8px;
            margin-top: 20px;
        }

        .help-section h3 {
            color: #2c3e50;
            margin-bottom: 10px;
        }

        .help-section code {
            background: #34495e;
            color: white;
            padding: 2px 6px;
            border-radius: 4px;
            font-family: monospace;
        }

        .help-section ul {
            margin-left: 20px;
        }

        .help-section li {
            margin: 5px 0;
        }
    </style>
</head>
<body>
    <div class="session-warning" id="sessionWarning">
        ‚ö†Ô∏è Session expires in <span id="warningTime">5</span> minutes. Click to extend.
    </div>




    <div class="container">
        <div class="header">
            <h1>üê† Aquarium System Database - Admin Panel</h1>
            <div class="header-controls">
                <div class="session-info" id="sessionInfo">
                    Loading session info...
                </div>
                <button class="logout-btn" onclick="logout()">
                    Logout
                </button>
            </div>
        </div>

        <div class="content">
            <!-- Quick Queries Section -->
            <div class="section">
                <h2>üìä Quick Queries</h2>
         
                <div class="quick-queries">
                    <button class="quick-btn" onclick="executeQuickQuery('last24h')">Last 24 Hours</button>
                    <button class="quick-btn" onclick="executeQuickQuery('all_events')">All Events</button>
                    <button class="quick-btn" onclick="executeQuickQuery('today_stats')">Today's Stats</button>
                    <button class="quick-btn" onclick="executeQuickQuery('errors')">Errors</button>
                    <button class="quick-btn" onclick="executeQuickQuery('monthly')">Daily Summary</button>
                    <button class="quick-btn" onclick="executeQuickQuery('algorithm_cycles')">ü§ñ Algorithm Cycles</button>
                    <button class="quick-btn" onclick="executeQuickQuery('algorithm_stats')">üìä Algorithm Stats</button>
                    <button class="quick-btn" onclick="executeQuickQuery('algorithm_failures')">‚ö†Ô∏è Algorithm Issues</button>
                    <button class="quick-btn" onclick="executeQuickQuery('statistics_resets')">üîÑ Statistics Resets</button>
                </div>
            </div>

            
            <!-- Results Section -->
            <div class="section">
                <div class="results-header">
                    <h2>üìã Query Results</h2>
                    <div class="results-info" id="resultsInfo">Ready for query</div>
                </div>
                
                <div id="resultsContainer">
                    <div class="no-results">Enter a SQL query and click Execute to see results</div>
                </div>
            </div>

            <!-- Custom SQL Query Section -->
            <div class="section">
                <h2>üíª Custom SQL Query</h2>
                <div class="sql-editor">
                    <textarea 
                        id="sqlQuery" 
                        class="sql-textarea" 
                        placeholder="SELECT * FROM water_events ORDER BY received_at DESC LIMIT 50;"
                    ></textarea>
                </div>
                
                <div class="execute-section">
                    <button class="execute-btn" onclick="executeCustomQuery()" id="executeBtn">
                        Execute Query
                    </button>
                    
                    <div class="export-section" id="exportSection" style="display: none;">
                        <span>Export:</span>
                        <a href="#" class="export-btn" id="exportCsv">CSV</a>
                        <a href="#" class="export-btn" id="exportJson">JSON</a>
                    </div>
                </div>
            </div>
            
            <!-- Help Section -->
            <div class="help-section">
                <h3>üìö Help & Examples</h3>
                <p><strong>Available table:</strong> <code>water_events</code></p>
                <p><strong>Columns:</strong> id, device_id, timestamp, unix_time, event_type, volume_ml, water_status, system_status, received_at, client_ip</p>
                
                <p><strong>Example queries:</strong></p>
                <ul>
                    <li><code>SELECT COUNT(*) FROM water_events;</code> - Total events count</li>
                    <li><code>SELECT * FROM water_events WHERE event_type = 'AUTO_PUMP' LIMIT 10;</code> - Auto pump events</li>
                    <li><code>SELECT DATE(received_at), SUM(volume_ml) FROM water_events GROUP BY DATE(received_at);</code> - Daily volume</li>
                    <li><code>SELECT * FROM water_events WHERE water_status != 'OK';</code> - Water level issues</li>
                </ul>
                
                <p><strong>Restrictions:</strong></p>
                <ul>
                    <li>Only SELECT queries allowed</li>
                    <li>Maximum 1000 results</li>
                    <li>10 second query timeout</li>
                    <li>Only water_events table accessible</li>
                </ul>

                <p><strong>Session Management:</strong></p>
                <ul>
                    <li>Session timeout: 30 minutes of inactivity</li>
                    <li>Auto-logout warning at 5 minutes remaining</li>
                    <li>Account lockout: 8 failed attempts = 1 hour ban</li>
                </ul>
            </div>
        </div>
    </div>

    <script>
   
        // let QUICK_QUERIES = {};
        // let currentQuery = '';
        // let currentResults = [];
        let currentQueryType = '';
        let sessionTimer = null;
        let warningShown = false;

        // Za≈Çaduj zapytania z API na starcie
        // async function loadQueries() {
        //     try {
        //         const response = await fetch('/api/admin-queries-definitions');
        //         const data = await response.json();
        //         if (data.success) {
        //             QUICK_QUERIES = data.queries;
        //             console.log('‚úÖ Queries loaded from API:', Object.keys(QUICK_QUERIES));
        //         }
        //     } catch (error) {
        //         console.error('‚ùå Failed to load queries:', error);
        //     }
        // }


        // loadQueries();

        // Mapowanie nazw kolumn
        function translateColumnName(columnName) {
            const translations = {
                'id': 'ID',
                'device_id': 'Device-ID',
                'timestamp': 'Event Time',
                'unix_time': 'Unix Time',
                'event_type': 'Event Type',
                'volume_ml': 'Water Filled Volume ',
                'water_status': 'Water Status',
                'system_status': 'System Status',
                'received_at': 'Log Receipt Time',
                'client_ip': 'Client IP',
                'time_gap_1': 'Turn-ON Delay',
                'time_gap_2': 'Turn-OFF Delay',
                'water_trigger_time': 'Water fill Delay',
                'pump_duration': 'Pump Run Time',
                'pump_attempts': 'Pr√≥by Pompy',
                'gap1_fail_sum': 'Turn-ON Error Count',
                'gap2_fail_sum': 'Turn-OFF Error Count', 
                'water_fail_sum': 'Water Fill Error',
                'last_reset_timestamp': 'Last Reset Timestamp',
                'algorithm_data': 'Event Log'
            };
            
            return translations[columnName] || columnName;
        }

        // Mapowanie warto≈õci na polskie
        function translateCellValue(columnName, value) {

            if (columnName === 'timestamp' && value) {
                return value.replace(/\s*\([^)]*\)\s*$/, '');
            }

            const valueTranslations = {
                'event_type': {
                    'AUTO_PUMP': 'AUTO PUMP',
                    'MANUAL_NORMAL': 'MANUAL FILL',
                    'MANUAL_EXTENDED': 'PUMP CALIBRATION',
                    'AUTO_CYCLE_COMPLETE': 'AUTO FILL',
                    'STATISTICS_RESET': 'STATISTICS RESET'
                },
                'water_status': {
                    'OK': 'OK',
                    'NORMAL': 'NORMAL',
                    'LOW': 'LOW  ',
                    'BOTH_LOW': 'BOTH LOW',
                    'SENSOR1_LOW': 'SENSOR 1 LOW',
                    'SENSOR2_LOW': 'SENSOR 2 LOW',
                    'PARTIAL': 'PARTIAL',
                    'CHECKING': 'CHECKING'
                },
                'system_status': {
                    'OK': 'SYSTEM OK',
                    'ERROR': 'ERROR'
                }
            };
            
            if (valueTranslations[columnName] && valueTranslations[columnName][value]) {
                return valueTranslations[columnName][value];
            }
            
            return value;
        }

        // Load session info on page load
        function loadSessionInfo() {
            fetch('/api/session-info')
                .then(response => response.json())
                .then(data => {
                    const sessionInfo = document.getElementById('sessionInfo');
                    const loginTime = new Date(data.login_time).toLocaleTimeString();
                    sessionInfo.innerHTML = `
                        üïí ${loginTime}<br>
                        <small>IP: ${data.client_ip}</small>
                    `;
                    
                    // Start session timer
                    startSessionTimer(data.timeout_minutes);
                })
                .catch(error => {
                    console.error('Failed to load session info:', error);
                });
        }

        function startSessionTimer(timeoutMinutes) {
            const totalMs = timeoutMinutes * 60 * 1000;
            const warningMs = 5 * 60 * 1000; // 5 minutes warning
            
            setTimeout(() => {
                showSessionWarning();
            }, totalMs - warningMs);
        }

        function showSessionWarning() {
            if (warningShown) return;
            warningShown = true;
            
            const warning = document.getElementById('sessionWarning');
            warning.style.display = 'block';
            
            let timeLeft = 5 * 60; // 5 minutes in seconds
            const warningTimeSpan = document.getElementById('warningTime');
            
            const countdown = setInterval(() => {
                const minutes = Math.floor(timeLeft / 60);
                const seconds = timeLeft % 60;
                warningTimeSpan.textContent = `${minutes}:${seconds.toString().padStart(2, '0')}`;
                
                timeLeft--;
                
                if (timeLeft < 0) {
                    clearInterval(countdown);
                    alert('Session expired. You will be redirected to login page.');
                    window.location.href = '/login';
                }
            }, 1000);
            
            // Click warning to extend session (make any API call)
            warning.onclick = () => {
                fetch('/api/session-info')
                    .then(() => {
                        warning.style.display = 'none';
                        warningShown = false;
                        clearInterval(countdown);
                        showAlert('Session extended successfully', 'success');
                    });
            };
        }

        function showAlert(message, type) {
            const resultsContainer = document.getElementById('resultsContainer');
            const alert = document.createElement('div');
            alert.className = 'alert ' + type;
            alert.textContent = message;
            
            // Insert at top of results container
            resultsContainer.insertBefore(alert, resultsContainer.firstChild);
            
            setTimeout(() => {
                if (resultsContainer.contains(alert)) {
                    resultsContainer.removeChild(alert);
                }
            }, 5000);
        }

        function updateResultsInfo(count, limited = false) {
            const info = document.getElementById('resultsInfo');
            let text = `${count} rows returned`;
            if (limited) {
                text += ' (limited to 1000)';
            }
            info.textContent = text;


        }




        function displayResults(data) {
            const container = document.getElementById('resultsContainer');
            
            if (!data || data.length === 0) {
                container.innerHTML = '<div class="no-results">No results found</div>';
                updateResultsInfo(0);
                document.getElementById('exportSection').style.display = 'none';
                return;
            }

            // Create table
            const table = document.createElement('table');
            table.className = 'results-table';

            // Create header
            const thead = document.createElement('thead');
            const headerRow = document.createElement('tr');

            // const columnKeys = Object.keys(data[0]);

            const preferredColumnOrder = [
                'id','device_id', 'timestamp', 'event_type', 'pump_duration', 'pump_attempts', 'volume_ml', 'time_gap_1', 'time_gap_2'
                , 'water_trigger_time','gap1_fail_sum', 'gap2_fail_sum', 'water_fail_sum',
                 'client_ip', 'water_status', 'system_status', 'received_at', 'last_reset_timestamp',
                , 'unix_time', 'algorithm_data', 
            ];

            const columnCategories = {
                'id': 'th-id',
                'device_id': 'th-device_id',
                'timestamp': 'th-timestamp',
                'event_type': 'th-event_type',
                'pump_duration': 'th-pump_duration',
                'pump_attempts': 'th-pump_attempts',
                'volume_ml': 'th-volume_ml',
                'time_gap_1': 'th-time_gap_1',
                'time_gap_2': 'th-time_gap_2',
                'water_trigger_time': 'th-water_trigger_time',
                'gap1_fail_sum': 'th-gap1_fail_sum',
                'gap2_fail_sum': 'th-gap2_fail_sum',
                'water_fail_sum': 'th-water_fail_sum',
                'client_ip': 'th-client_ip',
                'water_status': 'th-water_status',
                'system_status': 'th-system_status',
                'received_at': 'th-received_at',
                'last_reset_timestamp': 'th-last_reset_timestamp',
                'unix_time': 'th-unik_time',
                'algorithm_data': 'th-algorithm_data',
            };

            const availableColumns = Object.keys(data[0]);
            const columnKeys = preferredColumnOrder.filter(col => availableColumns.includes(col))
                             .concat(availableColumns.filter(col => !preferredColumnOrder.includes(col)));
            
            columnKeys.forEach(key => {
                const th = document.createElement('th');
                const span = document.createElement('span');
                span.textContent = translateColumnName(key);
                th.appendChild(span);

                const categoryClass = columnCategories[key] || 'th-default';
                th.classList.add(categoryClass);

                headerRow.appendChild(th);
            });


            
            thead.appendChild(headerRow);
            table.appendChild(thead);

            // Sprawd≈∫ liczbƒô kolumn i dodaj klasƒô CSS
            if (columnKeys.length < 8) {
                table.classList.add('few-columns');
            }



            // Create body
            const tbody = document.createElement('tbody');
            
            data.forEach(row => {
                const tr = document.createElement('tr');

                    const eventType = row['event_type'];
                if (eventType) {
                    const rowClass = getEventTypeRowClass(eventType);
                    tr.classList.add(rowClass);
                }

                columnKeys.forEach(columnName => {
                    const td = document.createElement('td');
                    const value = row[columnName];
                    const translatedValue = translateCellValue(columnName, value);
                    td.textContent = (translatedValue !== null && translatedValue !== undefined) ? translatedValue : '';
                    tr.appendChild(td);
                });
                
                tbody.appendChild(tr);
            });
            
            table.appendChild(tbody);
            container.innerHTML = '';
            container.appendChild(table);

            // Show export options
            document.getElementById('exportSection').style.display = 'flex';
            setupExportLinks();
        }

        function getEventTypeRowClass(eventType) {
            const eventTypeClasses = {
                'AUTO_PUMP': 'row-auto-pump',
                'MANUAL_NORMAL': 'row-manual-normal', 
                'MANUAL_EXTENDED': 'row-manual-extended',
                'AUTO_CYCLE_COMPLETE': 'row-auto-complete',
                'STATISTICS_RESET': 'row-stats-reset'
            };

            return eventTypeClasses[eventType] || 'row-default';
        }

        function setupExportLinks() {
            const csvLink = document.getElementById('exportCsv');
            const jsonLink = document.getElementById('exportJson');
            
            csvLink.onclick = () => exportData('csv');
            jsonLink.onclick = () => exportData('json');
        }

        function exportData(format) {
            if (!currentQueryType) {
                showAlert('No query to export', 'error');
                return;
            }
        
            // U≈ºyj nowego API endpoint - bez znajomo≈õci SQL
            const url = `/api/quick-export/${currentQueryType}/${format}`;
            window.open(url, '_blank');
        }       

        function executeQuery(query, isQuick = false) {
            if (!query.trim()) {
                showAlert('Please enter a SQL query', 'error');
                return;
            }

            // currentQuery = query;
            
            const container = document.getElementById('resultsContainer');
            container.innerHTML = '<div class="loading">Executing query...</div>';
            
            const executeBtn = document.getElementById('executeBtn');
            executeBtn.disabled = true;
            executeBtn.textContent = 'Executing...';

            const endpoint = isQuick ? `/api/admin-quick-query/${query}` : '/api/admin-query';
            const requestData = isQuick ? null : { query: query };

            fetch(endpoint, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: requestData ? JSON.stringify(requestData) : null
            })
            .then(response => {
                if (response.status === 401) {
                    // Session expired
                    alert('Session expired. Please login again.');
                    window.location.href = '/login';
                    return;
                }
                return response.json();
            })
            .then(data => {
                if (data && data.success) {
                    // currentResults = data.data;
                    displayResults(data.data);
                    updateResultsInfo(data.count, data.limited);
                    
                    if (data.limited) {
                        showAlert('Results limited to 1000 rows. Use LIMIT clause for specific ranges.', 'info');
                    }
                } else if (data) {
                    showAlert(`Error: ${data.error}`, 'error');
                    document.getElementById('exportSection').style.display = 'none';
                }
            })
            .catch(error => {
                showAlert(`Network error: ${error.message}`, 'error');
                document.getElementById('exportSection').style.display = 'none';
            })
            .finally(() => {
                executeBtn.disabled = false;
                executeBtn.textContent = 'Execute Query';
            });
        }

        function executeCustomQuery() {
            const query = document.getElementById('sqlQuery').value;
            executeQuery(query, false);
        }

        function executeQuickQuery(type) {

            currentQueryType = type; // DODAJ Tƒò LINIƒò
            const container = document.getElementById('resultsContainer');
            container.innerHTML = '<div class="loading">Executing query...</div>';
            
            fetch(`/api/admin-quick-query/${type}`)
            .then(response => {
                if (response.status === 401) {
                    alert('Session expired. Please login again.');
                    window.location.href = '/login';
                    return;
                }
                return response.json();
            })
            .then(data => {
                if (data && data.success) {
                    // currentResults = data.data;
                    displayResults(data.data);
                    updateResultsInfo(data.count);
                    


                    // Set current query for export
                    // currentQuery = getQuickQuerySQL(type);
                } else if (data) {
                    showAlert(`Error: ${data.error}`, 'error');
                }
            })
            .catch(error => {
                showAlert(`Network error: ${error.message}`, 'error');
            });
        }

        function logout() {
            if (confirm('Are you sure you want to logout?')) {
                fetch('/logout', { method: 'POST' })
                    .then(() => {
                        window.location.href = '/login';
                    })
                    .catch(() => {
                        // Even if request fails, redirect to login
                        window.location.href = '/login';
                    });
            }
        }

        // Load default query on page load
        document.addEventListener('DOMContentLoaded', function() {
            document.getElementById('sqlQuery').value = 'SELECT * FROM water_events ORDER BY received_at DESC LIMIT 20;';
            loadSessionInfo();
        });

        // Execute query on Ctrl+Enter
        document.getElementById('sqlQuery').addEventListener('keydown', function(e) {
            if (e.ctrlKey && e.key === 'Enter') {
                executeCustomQuery();
            }
        });

        // Heartbeat to keep session alive during active use
        setInterval(() => {
            if (!warningShown) {
                fetch('/api/session-info')
                    .catch(() => {
                        // Session might be expired
                        console.log('Session check failed');
                    });
            }
        }, 5 * 60 * 1000); // Every 5 minutes
    </script>
</body>
</html>
